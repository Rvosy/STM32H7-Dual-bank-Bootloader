# STM32H7 Dual Bank Bootloader

åŸºäº STM32H7 ç³»åˆ— Dual Bank æ¶æ„çš„ Bank Swap Bootloaderï¼Œæ”¯æŒåŒ App åŒºåŸŸåˆ‡æ¢ï¼Œå®ç°å®‰å…¨å¯é çš„ OTA å‡çº§ã€‚

## âœ¨ ç‰¹æ€§

- **Dual Bank æ¶æ„**ï¼šåˆ©ç”¨ STM32H7 ç¡¬ä»¶ Bank Swap åŠŸèƒ½ï¼Œé›¶æ‹·è´åˆ‡æ¢å›ºä»¶
- **åŒ Slot å†—ä½™**ï¼šSlot A/B åŒé•œåƒï¼Œæ”¯æŒæ•…éšœå›æ»š
- **é•œåƒå®Œæ•´æ€§æ ¡éªŒ**ï¼šMagic + Vector Table + CRC32 ä¸‰é‡éªŒè¯
- **è¯­ä¹‰åŒ–ç‰ˆæœ¬ç®¡ç†**ï¼šè‡ªåŠ¨é€‰æ‹©æ›´é«˜ç‰ˆæœ¬çš„å›ºä»¶å¯åŠ¨
- **æ— ç¼å‡çº§**ï¼šæ–°å›ºä»¶å†™å…¥å¤‡ç”¨ Bankï¼ŒéªŒè¯é€šè¿‡å Bank Swap åˆ‡æ¢

## ğŸ“¦ å†…å­˜å¸ƒå±€

| Bank | åŒºåŸŸ | åœ°å€èŒƒå›´ | å¤§å° | è¯´æ˜ |
|------|------|----------|------|------|
| Bank1 | Bootloader | `0x08000000 - 0x0801FFFF` | 128KB | Boot å‰¯æœ¬ 1 |
| Bank1 | **Slot A** | `0x08020000 - 0x080FFFFF` | 896KB | App åŒº |
| Bank2 | Bootloader | `0x08100000 - 0x0811FFFF` | 128KB | Boot å‰¯æœ¬ 2 |
| Bank2 | **Slot B** | `0x08120000 - 0x081FFFFF` | 896KB | App åŒº |

> Bank Swap åï¼ŒBank1/Bank2 çš„åœ°å€æ˜ å°„äº’æ¢ã€‚ç”±äºä¸¤ä¸ª Bank éƒ½æœ‰ç›¸åŒçš„ Bootloaderï¼Œæ— è®ºå“ªä¸ª Bank åœ¨å‰ï¼ŒBootloader éƒ½èƒ½æ­£å¸¸è¿è¡Œå¹¶è·³è½¬åˆ° `0x08020000` (å½“å‰ Bank çš„ App åŒº)

## ğŸ”§ é•œåƒå¤´æ ¼å¼

æ¯ä¸ª App é•œåƒå‰éœ€åŒ…å« 512 å­—èŠ‚ (`0x200`) çš„é•œåƒå¤´ï¼š

```c
typedef struct {
    uint32_t magic;       // å›ºå®š 0xA5A55A5A
    uint16_t hdr_version; // Header ç‰ˆæœ¬å·
    uint16_t flags;       // é¢„ç•™æ ‡å¿—ä½
    semver_t ver;         // è¯­ä¹‰ç‰ˆæœ¬ (major.minor.patch)
    uint32_t img_size;    // é•œåƒå¤§å° (ä¸å« header)
    uint32_t img_crc32;   // é•œåƒ CRC32 (ä¸å« header)
} image_hdr_t;
```

## ğŸš€ å¯åŠ¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¤ä½å¯åŠ¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥è·³è½¬æ ‡å¿— â”‚â”€â”€â”€â”€ æœ‰æ•ˆ â”€â”€â”€â–¶ ç›´æ¥è·³è½¬ App
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ æ— æ•ˆ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ ¡éªŒ Slot A  â”‚
â”‚ æ ¡éªŒ Slot B  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     A/B éƒ½æ— æ•ˆ
â”‚ ç‰ˆæœ¬æ¯”è¾ƒé€‰æ‹© â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ è¿›å…¥ DFU æ¨¡å¼
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ B ç‰ˆæœ¬æ›´é«˜?  â”‚â”€â”€â”€â”€ æ˜¯ â”€â”€â”€â–¶ Bank Swap + å¤ä½
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å¦
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·³è½¬ Slot A  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒ

- **MCU**: STM32H743 (2MB Flash, Dual Bank)
- **IDE**: Keil MDK-ARM / EIDE (VS Code)
- **HAL**: STM32Cube HAL

## ğŸ“ App å¼€å‘æ³¨æ„äº‹é¡¹

1. App é“¾æ¥åœ°å€éœ€è®¾ç½®ä¸º `0x08020200` (Slot åŸºå€ + Header å¤§å°)
2. ç¼–è¯‘åä½¿ç”¨å·¥å…·åœ¨ bin æ–‡ä»¶å‰æ·»åŠ é•œåƒå¤´

## ğŸ”¨ æ„å»ºå·¥å…·

### fill_hdr_crc.py

ç”¨äºå¡«å……é•œåƒå¤´ä¸­çš„ `img_size` å’Œ `img_crc32` å­—æ®µã€‚CRC32 ç®—æ³•ä¸ STM32 ç¡¬ä»¶ CRC å¤–è®¾ä¸€è‡´ (å¤šé¡¹å¼ `0x04C11DB7`ï¼Œåˆå§‹å€¼ `0xFFFFFFFF`ï¼Œæ— åè½¬)ã€‚

**ä½¿ç”¨æ–¹æ³•ï¼š**

```bash
py -3 ".\Tools\fill_hdr_crc.py" <input.bin> --out <output.bin> [options]
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `in_bin` | (å¿…å¡«) | è¾“å…¥ bin æ–‡ä»¶ (éœ€åŒ…å«é•œåƒå¤´) |
| `--out` | åŸåœ°è¦†ç›– | è¾“å‡º bin æ–‡ä»¶è·¯å¾„ |
| `--hdr-size` | `0x200` | é•œåƒå¤´å¤§å° |
| `--img-size-off` | `20` | `img_size` å­—æ®µåœ¨å¤´ä¸­çš„åç§» |
| `--crc-off` | `24` | `img_crc32` å­—æ®µåœ¨å¤´ä¸­çš„åç§» |
| `--pad` | `0xFF` | å°¾éƒ¨å¯¹é½å¡«å……å­—èŠ‚ |

**Keil åå¤„ç†é…ç½®ï¼š**

åœ¨ Keil Options â†’ User â†’ After Build ä¸­æ·»åŠ ï¼š

```
py -3 ".\Tools\fill_hdr_crc.py" ".\Output\@L.bin" --out ".\Output\@L_patched.bin" --hdr-size 0x200 --img-size-off 20 --crc-off 24
```

**Keil å¸¸ç”¨å®ï¼š**

| å® | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|
| `@L` | å·¥ç¨‹å (linker output name) | `Bootloader` |
| `@P` | å·¥ç¨‹æ–‡ä»¶è·¯å¾„ (ä¸å«æ‰©å±•å) | `D:\Project\Bootloader` |
| `@H` | å·¥ç¨‹æ–‡ä»¶æ‰€åœ¨ç›®å½• | `D:\Project\` |
| `@F` | å·¥ç¨‹æ–‡ä»¶å (ä¸å«è·¯å¾„å’Œæ‰©å±•å) | `Bootloader` |
| `@J` | å·¥ç¨‹æ–‡ä»¶å (å«æ‰©å±•å) | `Bootloader.uvprojx` |
| `#L` | é“¾æ¥å™¨è¾“å‡ºæ–‡ä»¶è·¯å¾„ (ä¸å«æ‰©å±•å) | `.\Objects\Bootloader` |
| `#H` | é“¾æ¥å™¨è¾“å‡ºç›®å½• | `.\Objects\` |

## è®¡åˆ’è¡¨
- [x] åŸºç¡€ Bootloader åŠŸèƒ½å®ç°
- [x] é•œåƒå¤´æ ¼å¼å®šä¹‰ä¸æ ¡éªŒ
- [x] ç‰ˆæœ¬æ¯”è¾ƒä¸é€‰æ‹©é€»è¾‘
- [x] Bank Swap åˆ‡æ¢å®ç°
- [ ] å›æ»šæœºåˆ¶
- [ ] DFU æ¨¡å¼å®ç°
- [ ] æ”¯æŒåŠ å¯†å›ºä»¶

## ğŸ“„ License

GPL-3.0 License
