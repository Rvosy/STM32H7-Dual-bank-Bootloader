# SPDX-License-Identifier: GPL-2.0-or-later
# Custom wrapper: dual-bank + mirror boot to bank2 when programming at 0x08000000

# 1) 启用 dual bank 并加载标准 target 脚本
set DUAL_BANK 1
source [find target/stm32h7x.cfg]

# 2) 劫持 program：当 program <file> 0x08000000 verify 时，额外再写 0x08100000
rename program _openocd_program

proc program {filename args} {
    # 解析参数：可能是 [addr] [verify] [reset] [exit]
    set addr ""
    set do_verify 0
    set do_reset  0
    set do_exit   0

    if {[llength $args] > 0 && [string match 0x* [lindex $args 0]]} {
        set addr [lindex $args 0]
        set rest [lrange $args 1 end]
    } else {
        set rest $args
    }

    foreach a $rest {
        if {$a eq "verify"} { set do_verify 1 }
        if {$a eq "reset"}  { set do_reset 1 }  ;# 不建议转发，让插件控制
        if {$a eq "exit"}   { set do_exit  1 }  ;# 不建议转发，让插件控制
    }

    # 转发到原生 program：只转发 addr + verify（reset/exit 交给插件后面的 -c）
    set fwd {}
    if {$addr ne ""} { lappend fwd $addr }
    if {$do_verify}  { lappend fwd verify }

    _openocd_program $filename {*}$fwd

    # 如果目标地址是 0x08000000，则镜像写入 bank2 起始 0x08100000
    if {$addr eq "0x08000000"} {
        echo "== Mirror write to Bank2 @ 0x08100000 =="
        set fwd2 [list 0x08100000]
        if {$do_verify} { lappend fwd2 verify }
        _openocd_program $filename {*}$fwd2
    }
}
