# app_flash_auto_trailer.cfg
# App flashing: NO reset run, auto erase trailer sector based on program address

source [find target/stm32h7x_dual_bank.cfg]

# --------- constants (adjust if you change layout) ----------
set SLOT_A_BASE      0x08020000
set SLOT_B_BASE      0x08120000
set SLOT_TOTAL_SIZE  0x000E0000
set TRAILER_SIZE     0x00020000

# --------- one-time init/halt guard ----------
if {![info exists ::__APP_FLASH_INITED__]} {
    set ::__APP_FLASH_INITED__ 1
    init
    reset halt
}

# --------- helper: decide trailer base from program addr ----------
proc _calc_trailer_base {addr} {
    global SLOT_A_BASE SLOT_B_BASE SLOT_TOTAL_SIZE TRAILER_SIZE

    # Tcl expr works with hex like 0x08120000
    if {$addr >= $SLOT_A_BASE && $addr < ($SLOT_A_BASE + $SLOT_TOTAL_SIZE)} {
        return [expr {$SLOT_A_BASE + $SLOT_TOTAL_SIZE - $TRAILER_SIZE}]
    }
    if {$addr >= $SLOT_B_BASE && $addr < ($SLOT_B_BASE + $SLOT_TOTAL_SIZE)} {
        return [expr {$SLOT_B_BASE + $SLOT_TOTAL_SIZE - $TRAILER_SIZE}]
    }
    return ""
}

# --------- hijack program ----------
rename program _openocd_program

proc program {filename args} {
    global TRAILER_SIZE

    # parse addr + verify
    set addr ""
    set do_verify 0

    if {[llength $args] > 0 && [string match 0x* [lindex $args 0]]} {
        set addr [lindex $args 0]
        set rest [lrange $args 1 end]
    } else {
        set rest $args
    }

    foreach a $rest {
        if {$a eq "verify"} { set do_verify 1 }
    }

    # ensure halted (safe even if already halted)
    reset halt

    # auto erase trailer if addr points into slot A/B
    if {$addr ne ""} {
        set tr_base [_calc_trailer_base $addr]
        if {$tr_base ne ""} {
            puts [format "Auto erasing trailer: base=0x%08X size=0x%X" $tr_base $TRAILER_SIZE]
            flash erase_address $tr_base $TRAILER_SIZE
        } else {
            puts [format "No trailer erase: addr=0x%08X not in slot region" $addr]
        }
    } else {
        puts "WARNING: no program address provided -> cannot auto erase trailer"
        puts "TIP: use .bin + explicit address, e.g. program app.bin 0x08120000 verify"
    }

    # forward only addr + verify (do NOT forward reset/exit)
    set fwd {}
    if {$addr ne ""} { lappend fwd $addr }
    if {$do_verify}  { lappend fwd verify }

    _openocd_program $filename {*}$fwd

    # force shutdown so caller's later 'reset run' won't happen
    shutdown
}
