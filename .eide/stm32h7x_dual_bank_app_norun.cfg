# App flashing: NO reset run (force shutdown after program)

source [find target/stm32h7x_dual_bank.cfg]

# 劫持 program
rename program _openocd_program

proc program {filename args} {
    # 解析参数：第一个可能是地址
    set addr ""
    set do_verify 0

    if {[llength $args] > 0 && [string match 0x* [lindex $args 0]]} {
        set addr [lindex $args 0]
        set rest [lrange $args 1 end]
    } else {
        set rest $args
    }

    foreach a $rest {
        if {$a eq "verify"} { set do_verify 1 }
    }

    # 仅转发 addr + verify（不要转发 reset/exit）
    set fwd {}
    if {$addr ne ""} { lappend fwd $addr }
    if {$do_verify}  { lappend fwd verify }

    # 真实烧录
    _openocd_program $filename {*}$fwd

    # 关键：刷完立即退出 OpenOCD，阻止插件后续的 `reset run`
    shutdown
}
